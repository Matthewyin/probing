# ç½‘ç»œè¯Šæ–­å·¥å…·ç”¨æˆ·ä½¿ç”¨æ‰‹å†Œ

## ğŸ“– ç›®å½•

1. [å·¥å…·æ¦‚è¿°](#å·¥å…·æ¦‚è¿°)
2. [å®‰è£…å’Œç¯å¢ƒé…ç½®](#å®‰è£…å’Œç¯å¢ƒé…ç½®)
3. [å•ç›®æ ‡è¯Šæ–­](#å•ç›®æ ‡è¯Šæ–­)
4. [æ‰¹é‡è¯Šæ–­](#æ‰¹é‡è¯Šæ–­)
5. [è¾“å‡ºç»“æœè§£è¯»](#è¾“å‡ºç»“æœè§£è¯»)
6. [å¸¸è§é—®é¢˜æ’æŸ¥](#å¸¸è§é—®é¢˜æ’æŸ¥)
7. [é«˜çº§ç”¨æ³•](#é«˜çº§ç”¨æ³•)
8. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
9. [ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²](#ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²)

## ğŸ¯ å·¥å…·æ¦‚è¿°

### ä»€ä¹ˆæ˜¯ç½‘ç»œè¯Šæ–­å·¥å…·ï¼Ÿ

ç½‘ç»œè¯Šæ–­å·¥å…·æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç½‘ç»œè¿æ¥æ€§å’Œæ€§èƒ½åˆ†æå·¥å…·ï¼Œèƒ½å¤Ÿå¯¹æŒ‡å®šçš„åŸŸåã€IPåœ°å€æˆ–URLè¿›è¡Œå…¨é¢çš„ç½‘ç»œè¯Šæ–­ï¼ŒåŒ…æ‹¬DNSè§£æã€TCPè¿æ¥æµ‹è¯•ã€TLS/SSLå®‰å…¨åˆ†æã€HTTPå“åº”æ£€æŸ¥ã€ç½‘ç»œè·¯å¾„è¿½è¸ªå’Œå…¬ç½‘IPä¿¡æ¯æ”¶é›†ã€‚

### ä¸»è¦åŠŸèƒ½

| åŠŸèƒ½æ¨¡å— | æè¿° | è¾“å‡ºä¿¡æ¯ |
|----------|------|----------|
| **DNSè§£æåˆ†æ** | åŸŸåè§£ææ€§èƒ½å’Œè¯¦æƒ… | è§£ææ—¶é—´ã€IPåœ°å€ã€DNSæœåŠ¡å™¨ä¿¡æ¯ |
| **TCPè¿æ¥æµ‹è¯•** | æµ‹è¯•ç›®æ ‡ä¸»æœºçš„TCPè¿æ¥æ€§èƒ½ | è¿æ¥æ—¶é—´ã€æœ¬åœ°/è¿œç¨‹åœ°å€ã€Socketä¿¡æ¯ |
| **TLS/SSLåˆ†æ** | æ”¶é›†TLSæ¡æ‰‹å’Œè¯ä¹¦ä¿¡æ¯ | åè®®ç‰ˆæœ¬ã€åŠ å¯†å¥—ä»¶ã€è¯ä¹¦è¯¦æƒ…ã€æœ‰æ•ˆæœŸ |
| **HTTPå“åº”æ£€æŸ¥** | åˆ†æHTTP/HTTPSè¯·æ±‚å’Œå“åº” | çŠ¶æ€ç ã€å“åº”å¤´ã€å“åº”æ—¶é—´ã€é‡å®šå‘é“¾ |
| **ç½‘ç»œè·¯å¾„è¿½è¸ª** | è¿½è¸ªåˆ°ç›®æ ‡çš„ç½‘ç»œè·¯å¾„ï¼ˆmtr/tracerouteï¼‰ | è·³ç‚¹ä¿¡æ¯ã€å»¶è¿Ÿç»Ÿè®¡ã€ä¸¢åŒ…ç‡ã€ASNä¿¡æ¯ |
| **å…¬ç½‘IPä¿¡æ¯** | æ”¶é›†å‘èµ·ç«¯å…¬ç½‘IPåœ°ç†ä½ç½®ä¿¡æ¯ | IPåœ°å€ã€åœ°ç†ä½ç½®ã€ISPä¿¡æ¯ |
| **URLæ£€æµ‹** | æ”¯æŒç›´æ¥URLè¯Šæ–­ | è‡ªåŠ¨è§£æåŸŸåå’Œç«¯å£ï¼Œæ”¯æŒHTTP/HTTPS |
| **æ‰¹é‡è¯Šæ–­** | åŒæ—¶è¯Šæ–­å¤šä¸ªç›®æ ‡ | æ±‡æ€»ç»Ÿè®¡ã€æ€§èƒ½åˆ†æã€å®‰å…¨è¯„ä¼° |

### é€‚ç”¨åœºæ™¯

- **ç½‘ç«™æ€§èƒ½ç›‘æ§**ï¼šå®šæœŸæ£€æŸ¥ç½‘ç«™çš„è¿æ¥æ€§èƒ½å’Œå®‰å…¨çŠ¶æ€
- **ç½‘ç»œæ•…éšœæ’æŸ¥**ï¼šè¯Šæ–­ç½‘ç»œè¿æ¥é—®é¢˜å’Œæ€§èƒ½ç“¶é¢ˆ
- **å®‰å…¨å®¡è®¡**ï¼šæ£€æŸ¥TLSé…ç½®å’Œè¯ä¹¦çŠ¶æ€
- **æœåŠ¡å™¨ç›‘æ§**ï¼šæ‰¹é‡ç›‘æ§å¤šä¸ªæœåŠ¡å™¨çš„å¥åº·çŠ¶æ€
- **ç½‘ç»œåŸºç¡€è®¾æ–½è¯„ä¼°**ï¼šåˆ†æç½‘ç»œè·¯å¾„å’Œæ€§èƒ½ç‰¹å¾
- **APIæ¥å£ç›‘æ§**ï¼šç›‘æ§APIæœåŠ¡çš„å¯ç”¨æ€§å’Œå“åº”æ—¶é—´
- **CDNæ€§èƒ½åˆ†æ**ï¼šåˆ†æå†…å®¹åˆ†å‘ç½‘ç»œçš„æ€§èƒ½è¡¨ç°

## ğŸ› ï¸ å®‰è£…å’Œç¯å¢ƒé…ç½®

### ç³»ç»Ÿè¦æ±‚

- **æ“ä½œç³»ç»Ÿ**ï¼šLinuxã€macOSã€Windows
- **Pythonç‰ˆæœ¬**ï¼š3.11 æˆ–æ›´é«˜ç‰ˆæœ¬
- **ç½‘ç»œæƒé™**ï¼šèƒ½å¤Ÿè®¿é—®ç›®æ ‡ç½‘ç»œåœ°å€
- **å¯é€‰å·¥å…·**ï¼šmtrï¼ˆç”¨äºé«˜çº§ç½‘ç»œè·¯å¾„è¿½è¸ªï¼‰

### å®‰è£…æ­¥éª¤

#### 1. å®‰è£…uvåŒ…ç®¡ç†å™¨

uvæ˜¯ç°ä»£åŒ–çš„PythonåŒ…ç®¡ç†å™¨ï¼Œæä¾›æ›´å¿«çš„ä¾èµ–è§£æå’Œå®‰è£…é€Ÿåº¦ã€‚

**Linux/macOS:**
```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
```

**Windows:**
```powershell
powershell -c "irm https://astral.sh/uv/install.ps1 | iex"
```

**éªŒè¯å®‰è£…:**
```bash
uv --version
```

#### 2. è·å–é¡¹ç›®ä»£ç 

```bash
# å…‹éš†é¡¹ç›®åˆ°æœ¬åœ°
git clone https://github.com/Matthewyin/probing.git
cd probing
```

#### 3. å®‰è£…é¡¹ç›®ä¾èµ–

```bash
# uvä¼šè‡ªåŠ¨åˆ›å»ºè™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£…ä¾èµ–
uv sync

# æˆ–è€…æ‰‹åŠ¨å®‰è£…ä¾èµ–
uv add pydantic-settings httpx cryptography python-dotenv pyyaml
```

#### 4. ç¯å¢ƒé…ç½®

åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶ï¼š

```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿ï¼ˆåœ¨é¡¹ç›®æ ¹ç›®å½•ï¼‰
cp .env.example .env

# ç¼–è¾‘é…ç½®æ–‡ä»¶
nano .env
```

**.env æ–‡ä»¶ç¤ºä¾‹:**

```bash
# åº”ç”¨é…ç½®
APP_NAME="Network Diagnosis Tool"
APP_VERSION="1.0.0"
DEBUG=false

# ç½‘ç»œé…ç½®
CONNECT_TIMEOUT=10
READ_TIMEOUT=30
MAX_REDIRECTS=5

# è¾“å‡ºé…ç½®
OUTPUT_DIR="./network-diagnosis/output"

# æ—¥å¿—é…ç½®
LOG_LEVEL="INFO"
LOG_FORMAT="%(asctime)s - %(name)s - %(levelname)s - %(message)s"

# ç³»ç»Ÿé…ç½®ï¼ˆå·²å¼ƒç”¨ï¼Œç°ä½¿ç”¨sudoersé…ç½®ï¼‰
# SUDO_PASSWORD="your_password"
```

#### 5. éªŒè¯å®‰è£…

```bash
# æµ‹è¯•åŸºæœ¬åŠŸèƒ½
uv run python main.py --help

# è¿è¡Œç®€å•è¯Šæ–­
uv run python main.py google.com --no-trace
```

### å¯é€‰å·¥å…·å®‰è£…

#### å®‰è£…mtrï¼ˆå¼ºçƒˆæ¨èï¼‰

mtræä¾›æ›´è¯¦ç»†çš„ç½‘ç»œè·¯å¾„è¿½è¸ªä¿¡æ¯ï¼ŒåŒ…æ‹¬ASNä¿¡æ¯ã€ä¸¢åŒ…ç‡ç»Ÿè®¡ç­‰ï¼š

**Ubuntu/Debian:**

```bash
sudo apt-get install mtr-tiny
```

**CentOS/RHEL:**

```bash
sudo yum install mtr
```

**macOS:**

```bash
brew install mtr
```

**Windows:**

```bash
# ä½¿ç”¨å†…ç½®çš„tracertå‘½ä»¤ï¼Œæ— éœ€é¢å¤–å®‰è£…
```

#### é…ç½®mtræ— å¯†ç æ‰§è¡Œï¼ˆæ¨èï¼‰

ä¸ºäº†é¿å…æ¯æ¬¡æ‰§è¡Œmtræ—¶è¾“å…¥å¯†ç ï¼Œå»ºè®®é…ç½®sudoersï¼š

```bash
# ç¼–è¾‘sudoersæ–‡ä»¶
sudo visudo

# æ·»åŠ ä»¥ä¸‹è¡Œï¼ˆæ›¿æ¢ä¸ºå®é™…ç”¨æˆ·åï¼‰
username ALL=(ALL) NOPASSWD: /usr/bin/mtr, /opt/homebrew/sbin/mtr
```

## ğŸ¯ å•ç›®æ ‡è¯Šæ–­

### åŸºæœ¬ç”¨æ³•

å•ç›®æ ‡è¯Šæ–­ç”¨äºå¯¹å•ä¸ªåŸŸåæˆ–IPåœ°å€è¿›è¡Œè¯¦ç»†çš„ç½‘ç»œè¯Šæ–­ã€‚

#### æœ€ç®€å•çš„ä½¿ç”¨æ–¹å¼

```bash
# è¯Šæ–­ä¸€ä¸ªç½‘ç«™ï¼ˆä½¿ç”¨é»˜è®¤ç«¯å£443ï¼‰
uv run python main.py google.com
```

#### å®Œæ•´å‘½ä»¤æ ¼å¼

```bash
uv run python main.py <domain> [options]
```

### å‘½ä»¤è¡Œå‚æ•°è¯¦è§£

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | æè¿° | ç¤ºä¾‹ |
|------|------|--------|------|------|
| `domain` | å¿…éœ€ | - | ç›®æ ‡åŸŸåæˆ–IPåœ°å€ | `google.com` |
| `--port` | å¯é€‰ | 443 | ç›®æ ‡ç«¯å£å· | `--port 80` |
| `--no-trace` | æ ‡å¿— | false | è·³è¿‡ç½‘ç»œè·¯å¾„è¿½è¸ª | `--no-trace` |
| `--no-http` | æ ‡å¿— | false | è·³è¿‡HTTPå“åº”æ”¶é›† | `--no-http` |
| `--no-save` | æ ‡å¿— | false | ä¸ä¿å­˜ç»“æœåˆ°æ–‡ä»¶ | `--no-save` |

### ä½¿ç”¨ç¤ºä¾‹

#### 1. åŸºæœ¬HTTPSç½‘ç«™è¯Šæ–­

```bash
# è¯Šæ–­HTTPSç½‘ç«™ï¼ˆåŒ…å«æ‰€æœ‰åŠŸèƒ½ï¼‰
uv run python main.py github.com

# è¾“å‡ºç¤ºä¾‹ï¼š
# 2025-09-10 12:00:00 - INFO - Starting network diagnosis for github.com:443
# 2025-09-10 12:00:00 - INFO - Resolved github.com to 140.82.112.3
# 2025-09-10 12:00:00 - INFO - TCP connection successful in 45.23ms
# 2025-09-10 12:00:01 - INFO - TLS handshake completed in 156.78ms
# 2025-09-10 12:00:01 - INFO - HTTP request completed in 234.56ms
# 2025-09-10 12:00:02 - INFO - Network diagnosis completed in 567.89ms
```

#### 2. HTTPç½‘ç«™è¯Šæ–­

```bash
# è¯Šæ–­HTTPç½‘ç«™ï¼ˆç«¯å£80ï¼‰
uv run python main.py httpbin.org --port 80

# è·³è¿‡TLSåˆ†æï¼ˆå› ä¸ºæ˜¯HTTPï¼‰
uv run python main.py example.com --port 80 --no-trace
```

#### 3. è‡ªå®šä¹‰ç«¯å£è¯Šæ–­

```bash
# è¯Šæ–­è‡ªå®šä¹‰ç«¯å£
uv run python main.py example.com --port 8080

# è¯Šæ–­æ•°æ®åº“ç«¯å£ï¼ˆåªæµ‹è¯•TCPè¿æ¥ï¼‰
uv run python main.py db.example.com --port 3306 --no-http --no-trace
```

#### 4. å¿«é€Ÿè¿æ¥æµ‹è¯•

```bash
# åªæµ‹è¯•TCPè¿æ¥ï¼Œè·³è¿‡å…¶ä»–åŠŸèƒ½
uv run python main.py target.com --no-http --no-trace --no-save
```

#### 5. IPåœ°å€è¯Šæ–­

```bash
# ç›´æ¥è¯Šæ–­IPåœ°å€
uv run python main.py 8.8.8.8 --port 53 --no-http

# è¯Šæ–­å†…ç½‘IP
uv run python main.py 192.168.1.1 --port 80 --no-trace
```

### è¯Šæ–­æµç¨‹è¯´æ˜

1. **å…¬ç½‘IPä¿¡æ¯æ”¶é›†**ï¼šæ”¶é›†å‘èµ·ç«¯çš„å…¬ç½‘IPåœ°ç†ä½ç½®ä¿¡æ¯
2. **åŸŸåè§£æ**ï¼šå°†åŸŸåè§£æä¸ºIPåœ°å€ï¼Œè®°å½•è§£ææ—¶é—´
3. **TCPè¿æ¥æµ‹è¯•**ï¼šæµ‹è¯•åˆ°ç›®æ ‡çš„TCPè¿æ¥ï¼Œè®°å½•è¿æ¥æ—¶é—´å’ŒSocketä¿¡æ¯
4. **TLSæ¡æ‰‹**ï¼šå¦‚æœå¯ç”¨TLSä¸”æ˜¯HTTPSç«¯å£ï¼Œè¿›è¡ŒTLSæ¡æ‰‹å’Œè¯ä¹¦åˆ†æ
5. **HTTPè¯·æ±‚**ï¼šå¦‚æœå¯ç”¨HTTPï¼Œå‘é€HTTPè¯·æ±‚å¹¶åˆ†æå“åº”
6. **ç½‘ç»œè·¯å¾„è¿½è¸ª**ï¼šå¦‚æœå¯ç”¨è¿½è¸ªï¼Œä½¿ç”¨mtræˆ–tracerouteè¿½è¸ªç½‘ç»œè·¯å¾„
7. **ç»“æœä¿å­˜**ï¼šå°†è¯Šæ–­ç»“æœä¿å­˜ä¸ºJSONæ–‡ä»¶

### æ–°å¢åŠŸèƒ½ç‰¹æ€§

#### URLæ£€æµ‹æ”¯æŒ

å·¥å…·ç°åœ¨æ”¯æŒç›´æ¥ä½¿ç”¨URLè¿›è¡Œè¯Šæ–­ï¼š

```bash
# ä½¿ç”¨URLè¿›è¡Œè¯Šæ–­ï¼ˆè‡ªåŠ¨è§£æåŸŸåå’Œç«¯å£ï¼‰
uv run python main.py https://github.com/user/repo
uv run python main.py http://api.example.com:8080/health
```

#### TLSå¼€å…³æ§åˆ¶

å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶æ§åˆ¶æ˜¯å¦è¿›è¡ŒTLSæ£€æµ‹ï¼š

```yaml
targets:
  - domain: "example.com"
    port: 443
    include_tls: true    # å¯ç”¨TLSæ£€æµ‹
  - domain: "api.example.com"
    port: 80
    include_tls: false   # ç¦ç”¨TLSæ£€æµ‹
```

#### å¢å¼ºçš„mtrç½‘ç»œè¿½è¸ª

ä½¿ç”¨mtrå‘½ä»¤è¿›è¡Œç½‘ç»œè·¯å¾„è¿½è¸ªï¼Œæä¾›æ›´è¯¦ç»†çš„ä¿¡æ¯ï¼š

- ASNï¼ˆè‡ªæ²»ç³»ç»Ÿå·ï¼‰ä¿¡æ¯
- è¯¦ç»†çš„ä¸¢åŒ…ç‡ç»Ÿè®¡
- ç²¾ç¡®çš„å»¶è¿Ÿæµ‹é‡
- JSONæ ¼å¼è¾“å‡º

### è¾“å‡ºæ–‡ä»¶

æ¯æ¬¡è¯Šæ–­ä¼šåœ¨ `network-diagnosis/output/` ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ªJSONæ–‡ä»¶ï¼š

```text
network-diagnosis/output/network_diagnosis_github.com_443_20250910_120000_123.json
```

æ–‡ä»¶å‘½åæ ¼å¼ï¼š`network_diagnosis_{domain}_{port}_{timestamp}_{random}.json`

## ğŸ“Š æ‰¹é‡è¯Šæ–­

æ‰¹é‡è¯Šæ–­å…è®¸æ‚¨åŒæ—¶å¯¹å¤šä¸ªç›®æ ‡è¿›è¡Œç½‘ç»œè¯Šæ–­ï¼Œé€‚ç”¨äºç›‘æ§å¤šä¸ªæœåŠ¡å™¨æˆ–ç½‘ç«™çš„åœºæ™¯ã€‚

### é…ç½®æ–‡ä»¶ç¼–å†™æŒ‡å—

#### 1. åˆ›å»ºç¤ºä¾‹é…ç½®æ–‡ä»¶

```bash
# åˆ›å»ºç¤ºä¾‹é…ç½®æ–‡ä»¶
uv run python batch_main.py --create-sample

# è¿™ä¼šåˆ›å»º targets_sample.yaml æ–‡ä»¶
```

#### 2. é…ç½®æ–‡ä»¶ç»“æ„

```yaml
# targets.yaml
targets:
  # åŸŸå+ç«¯å£æ–¹å¼
  - domain: "google.com"
    port: 443
    include_trace: false
    include_http: true
    include_tls: true
    description: "Googleæœç´¢å¼•æ“"

  # URLæ–¹å¼ï¼ˆè‡ªåŠ¨è§£æåŸŸåå’Œç«¯å£ï¼‰
  - url: "https://github.com/user/repo"
    include_trace: false
    include_http: true
    include_tls: true
    description: "GitHubä»£ç æ‰˜ç®¡å¹³å°"

  # HTTPæœåŠ¡ï¼ˆç¦ç”¨TLSï¼‰
  - domain: "httpbin.org"
    port: 80
    include_trace: false
    include_http: true
    include_tls: false
    description: "HTTPæµ‹è¯•æœåŠ¡"

  # APIæ¥å£æµ‹è¯•
  - url: "http://api.example.com:8080/health"
    include_trace: false
    include_http: true
    include_tls: false
    description: "APIå¥åº·æ£€æŸ¥"

global_settings:
  # é»˜è®¤è®¾ç½®
  default_port: 443
  default_include_trace: false
  default_include_http: true
  default_include_tls: true

  # æ‰§è¡Œè®¾ç½®
  max_concurrent: 3
  timeout_seconds: 60

  # è¾“å‡ºè®¾ç½®
  save_individual_files: true
  save_summary_report: false  # é»˜è®¤å…³é—­æ‰¹é‡æ±‡æ€»æŠ¥å‘Š

  # åˆ†æè®¾ç½®
  include_performance_analysis: true
  include_security_analysis: true
```

#### 3. ç›®æ ‡é…ç½®å‚æ•°

| å‚æ•° | ç±»å‹ | å¿…éœ€ | é»˜è®¤å€¼ | æè¿° |
|------|------|------|--------|------|
| `domain` | string | âœ“* | - | åŸŸåæˆ–IPåœ°å€ï¼ˆä¸urläºŒé€‰ä¸€ï¼‰ |
| `url` | string | âœ“* | - | å®Œæ•´URLï¼ˆä¸domainäºŒé€‰ä¸€ï¼‰ |
| `port` | integer | âœ— | 443 | ç›®æ ‡ç«¯å£ (1-65535) |
| `include_trace` | boolean | âœ— | false | æ˜¯å¦æ‰§è¡Œç½‘ç»œè·¯å¾„è¿½è¸ª |
| `include_http` | boolean | âœ— | true | æ˜¯å¦æ”¶é›†HTTPå“åº”ä¿¡æ¯ |
| `include_tls` | boolean | âœ— | true | æ˜¯å¦è¿›è¡ŒTLSæ£€æµ‹ |
| `description` | string | âœ— | null | ç›®æ ‡æè¿°ä¿¡æ¯ |

*æ³¨ï¼š`domain` å’Œ `url` å¿…é¡»æä¾›å…¶ä¸­ä¸€ä¸ª

#### 4. å…¨å±€è®¾ç½®å‚æ•°

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | èŒƒå›´ | æè¿° |
|------|------|--------|------|------|
| `max_concurrent` | integer | 3 | 1-10 | æœ€å¤§å¹¶å‘è¯Šæ–­æ•° |
| `timeout_seconds` | integer | 60 | 10-300 | å•ä¸ªè¯Šæ–­è¶…æ—¶æ—¶é—´ |
| `save_individual_files` | boolean | true | - | æ˜¯å¦ä¿å­˜å•ä¸ªJSONæ–‡ä»¶ |
| `save_summary_report` | boolean | false | - | æ˜¯å¦ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š |
| `default_include_tls` | boolean | true | - | é»˜è®¤TLSæ£€æµ‹å¼€å…³ |

### æ‰¹é‡è¯Šæ–­æ‰§è¡Œæµç¨‹

#### 1. éªŒè¯é…ç½®æ–‡ä»¶

```bash
# éªŒè¯é…ç½®æ–‡ä»¶æ ¼å¼
uv run python batch_main.py --validate -c network-diagnosis/input/targets.yaml

# è¾“å‡ºç¤ºä¾‹ï¼š
# 2025-09-10 12:00:00 - INFO - Loading configuration from targets.yaml
# 2025-09-10 12:00:00 - INFO - Loaded 3 targets from configuration
# é…ç½®æ–‡ä»¶æ ¼å¼æ­£ç¡®: targets.yaml
```

#### 2. æ‰§è¡Œæ‰¹é‡è¯Šæ–­

```bash
# ä½¿ç”¨é»˜è®¤é…ç½®æ–‡ä»¶ network-diagnosis/input/targets.yaml
uv run python batch_main.py

# ä½¿ç”¨è‡ªå®šä¹‰é…ç½®æ–‡ä»¶
uv run python batch_main.py -c network-diagnosis/input/my_targets.yaml

# é™é»˜æ¨¡å¼ï¼ˆåªæ˜¾ç¤ºé”™è¯¯ï¼‰
uv run python batch_main.py --quiet -c network-diagnosis/input/targets.yaml

# ä¸æ˜¾ç¤ºè¯¦ç»†æ‘˜è¦
uv run python batch_main.py --no-summary -c network-diagnosis/input/targets.yaml
```

#### 3. æ‰¹é‡è¯Šæ–­å‘½ä»¤å‚æ•°

| å‚æ•° | æè¿° | ç¤ºä¾‹ |
|------|------|------|
| `-c, --config` | æŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„ | `-c targets.yaml` |
| `--validate` | åªéªŒè¯é…ç½®æ–‡ä»¶ï¼Œä¸æ‰§è¡Œè¯Šæ–­ | `--validate` |
| `--create-sample` | åˆ›å»ºç¤ºä¾‹é…ç½®æ–‡ä»¶ | `--create-sample` |
| `--quiet` | é™é»˜æ¨¡å¼ï¼Œåªæ˜¾ç¤ºé”™è¯¯ | `--quiet` |
| `--no-summary` | ä¸æ˜¾ç¤ºè¯¦ç»†æ‘˜è¦ | `--no-summary` |

### é…ç½®æ–‡ä»¶ç¤ºä¾‹

#### ç¤ºä¾‹1ï¼šWebæœåŠ¡å™¨ç›‘æ§

```yaml
targets:
  # ç”Ÿäº§ç¯å¢ƒ
  - domain: "api.example.com"
    port: 443
    include_http: true
    description: "ç”Ÿäº§APIæœåŠ¡å™¨"

  - domain: "www.example.com"
    port: 443
    include_http: true
    description: "ç”Ÿäº§WebæœåŠ¡å™¨"

  # æµ‹è¯•ç¯å¢ƒ
  - domain: "test-api.example.com"
    port: 443
    include_http: true
    description: "æµ‹è¯•APIæœåŠ¡å™¨"

global_settings:
  max_concurrent: 2
  timeout_seconds: 30
  save_summary_report: true
```

#### ç¤ºä¾‹2ï¼šæ•°æ®åº“æœåŠ¡å™¨ç›‘æ§

```yaml
targets:
  - domain: "db1.example.com"
    port: 3306
    include_http: false
    include_trace: false
    description: "MySQLä¸»æ•°æ®åº“"

  - domain: "db2.example.com"
    port: 3306
    include_http: false
    include_trace: false
    description: "MySQLä»æ•°æ®åº“"

  - domain: "redis.example.com"
    port: 6379
    include_http: false
    include_trace: false
    description: "Redisç¼“å­˜æœåŠ¡å™¨"

global_settings:
  max_concurrent: 3
  timeout_seconds: 15
  save_individual_files: true
```

#### ç¤ºä¾‹3ï¼šDNSæœåŠ¡å™¨ç›‘æ§

```yaml
targets:
  - domain: "8.8.8.8"
    port: 53
    include_http: false
    include_trace: true
    description: "Google DNS"

  - domain: "1.1.1.1"
    port: 53
    include_http: false
    include_trace: true
    description: "Cloudflare DNS"

  - domain: "208.67.222.222"
    port: 53
    include_http: false
    include_trace: true
    description: "OpenDNS"

global_settings:
  max_concurrent: 2
  timeout_seconds: 120  # è·¯å¾„è¿½è¸ªéœ€è¦æ›´é•¿æ—¶é—´
  include_performance_analysis: true
```

### æ‰¹é‡è¯Šæ–­è¾“å‡º

æ‰¹é‡è¯Šæ–­ä¼šæ ¹æ®é…ç½®æ–‡ä»¶ååˆ›å»ºç‹¬ç«‹çš„å­ç›®å½•ï¼Œå¹¶åœ¨å…¶ä¸­ç”Ÿæˆä»¥ä¸‹æ–‡ä»¶ï¼š

#### ç›®å½•ç»“æ„
```
network-diagnosis/
â”œâ”€â”€ output/
â”‚   â”œâ”€â”€ test_nssa_io/                    # åŸºäº test_nssa_io.yaml
â”‚   â”‚   â”œâ”€â”€ network_diagnosis_nssa.io_443_*.json
â”‚   â”‚   â””â”€â”€ network_diagnosis_nssa.io_80_*.json
â”‚   â”œâ”€â”€ targets_simple/                 # åŸºäº targets_simple.yaml
â”‚   â”‚   â”œâ”€â”€ network_diagnosis_google.com_443_*.json
â”‚   â”‚   â”œâ”€â”€ network_diagnosis_github.com_443_*.json
â”‚   â”‚   â””â”€â”€ network_diagnosis_httpbin.org_80_*.json
â”‚   â””â”€â”€ production_targets/             # åŸºäº production_targets.yaml
â”‚       â””â”€â”€ ...
â””â”€â”€ log/
    â”œâ”€â”€ test_nssa_io/
    â”‚   â””â”€â”€ diagnosis_*.log
    â”œâ”€â”€ targets_simple/
    â”‚   â””â”€â”€ diagnosis_*.log
    â””â”€â”€ production_targets/
        â””â”€â”€ diagnosis_*.log
```

#### æ–‡ä»¶ç±»å‹

1. **å•ä¸ªè¯Šæ–­ç»“æœ**ï¼š`network_diagnosis_{domain}_{port}_{timestamp}.json`
   - æ¯ä¸ªç›®æ ‡ï¼ˆåŸŸå+ç«¯å£ï¼‰ç”Ÿæˆç‹¬ç«‹çš„JSONæ–‡ä»¶
   - åŒ…å«å®Œæ•´çš„è¯Šæ–­ä¿¡æ¯ï¼ˆDNSã€TCPã€TLSã€HTTPç­‰ï¼‰
   - ä¾¿äºåç»­ç»Ÿä¸€åˆ†æå’Œå¤„ç†

2. **æ‰¹é‡è¯Šæ–­æŠ¥å‘Š**ï¼š`batch_diagnosis_report_{timestamp}.json`ï¼ˆé»˜è®¤å…³é—­ï¼‰
   - åŒ…å«æ‰€æœ‰ç›®æ ‡çš„ç»Ÿè®¡åˆ†æå’Œæ±‡æ€»ä¿¡æ¯
   - å¯é€šè¿‡é…ç½® `save_summary_report: true` å¯ç”¨

3. **æ–‡æœ¬åˆ†ææŠ¥å‘Š**ï¼š`analysis_report_{timestamp}.txt`ï¼ˆå¯é€‰ï¼‰
   - æ–‡æœ¬æ ¼å¼çš„åˆ†ææ‘˜è¦
   - ä»…åœ¨å¯ç”¨æ‰¹é‡è¯Šæ–­æŠ¥å‘Šæ—¶ç”Ÿæˆ

#### æ‰¹é‡è¯Šæ–­æ‘˜è¦ç¤ºä¾‹

```
================================================================================
æ‰¹é‡ç½‘ç»œè¯Šæ–­ç»“æœæ‘˜è¦
================================================================================
é…ç½®æ–‡ä»¶: targets.yaml
æ€»ç›®æ ‡æ•°: 3
æˆåŠŸè¯Šæ–­: 3
å¤±è´¥è¯Šæ–­: 0
æˆåŠŸç‡: 100.0%
æ€»æ‰§è¡Œæ—¶é—´: 1116.38ms

æ€§èƒ½ç»Ÿè®¡:
  å¹³å‡è¯Šæ–­æ—¶é—´: 372.13ms
  å¹³å‡TCPè¿æ¥æ—¶é—´: 1.40ms
  æœ€å¿«è¯Šæ–­: 345.72ms
  æœ€æ…¢è¯Šæ–­: 415.30ms

å®‰å…¨ç»Ÿè®¡:
  å¯ç”¨TLSè¿æ¥: 2
  å®‰å…¨è¿æ¥ç‡: 66.7%
  TLSåè®®åˆ†å¸ƒ:
    TLSv1.3: 2

HTTPçŠ¶æ€ç åˆ†å¸ƒ:
  200: 3

è¯¦ç»†ç»“æœ:
--------------------------------------------------------------------------------
 1. âœ“ google.com - 415.30ms
 2. âœ“ github.com - 395.72ms
 3. âœ“ httpbin.org - 345.55ms
================================================================================
```

## ğŸ“‹ è¾“å‡ºç»“æœè§£è¯»

### å•ä¸ªè¯Šæ–­ç»“æœæ ¼å¼

æ¯ä¸ªè¯Šæ–­ç»“æœåŒ…å«ä»¥ä¸‹ä¸»è¦éƒ¨åˆ†ï¼š

#### 1. åŸºæœ¬ä¿¡æ¯

```json
{
  "domain": "example.com",
  "target_ip": "93.184.216.34",
  "timestamp": "2025-09-10T12:00:00.000000",
  "success": true,
  "total_time_ms": 567.89,
  "error_messages": []
}
```

**å­—æ®µè¯´æ˜ï¼š**
- `domain`ï¼šè¯Šæ–­çš„ç›®æ ‡åŸŸå
- `target_ip`ï¼šè§£æåçš„ä¸»è¦IPåœ°å€
- `timestamp`ï¼šè¯Šæ–­å¼€å§‹æ—¶é—´
- `success`ï¼šè¯Šæ–­æ˜¯å¦æˆåŠŸ
- `total_time_ms`ï¼šæ€»è¯Šæ–­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
- `error_messages`ï¼šé”™è¯¯ä¿¡æ¯åˆ—è¡¨

#### 2. DNSè§£æä¿¡æ¯

```json
{
  "dns_resolution": {
    "domain": "example.com",
    "resolved_ips": [
      "93.184.216.34",
      "93.184.216.35"
    ],
    "primary_ip": "93.184.216.34",
    "resolution_time_ms": 15.23,
    "dns_server": "192.168.1.1",
    "record_type": "A",
    "is_successful": true,
    "error_message": null
  }
}
```

**DNSæ€§èƒ½æŒ‡æ ‡è§£è¯»ï¼š**
- `< 20ms`ï¼šä¼˜ç§€çš„DNSè§£ææ€§èƒ½
- `20-50ms`ï¼šè‰¯å¥½çš„DNSè§£ææ€§èƒ½
- `50-100ms`ï¼šä¸€èˆ¬çš„DNSè§£ææ€§èƒ½
- `> 100ms`ï¼šè¾ƒæ…¢çš„DNSè§£ææ€§èƒ½

**DNSä¿¡æ¯è¯´æ˜ï¼š**
- `resolved_ips`ï¼šåŸŸåè§£æåˆ°çš„æ‰€æœ‰IPåœ°å€
- `primary_ip`ï¼šé€‰æ‹©çš„ä¸»è¦IPåœ°å€
- `resolution_time_ms`ï¼šDNSæŸ¥è¯¢è€—æ—¶
- `dns_server`ï¼šä½¿ç”¨çš„DNSæœåŠ¡å™¨åœ°å€
- `record_type`ï¼šDNSè®°å½•ç±»å‹ï¼ˆAã€AAAAç­‰ï¼‰

#### 3. TCPè¿æ¥ä¿¡æ¯

```json
{
  "tcp_connection": {
    "host": "example.com",
    "port": 443,
    "target_ip": "93.184.216.34",
    "connect_time_ms": 45.23,
    "is_connected": true,
    "socket_family": "IPv4",
    "local_address": "192.168.1.100",
    "local_port": 54321,
    "error_message": null
  }
}
```

**æ€§èƒ½æŒ‡æ ‡è§£è¯»ï¼š**
- `< 50ms`ï¼šä¼˜ç§€çš„è¿æ¥æ€§èƒ½
- `50-100ms`ï¼šè‰¯å¥½çš„è¿æ¥æ€§èƒ½
- `100-200ms`ï¼šä¸€èˆ¬çš„è¿æ¥æ€§èƒ½
- `> 200ms`ï¼šè¾ƒæ…¢çš„è¿æ¥æ€§èƒ½

**TCPè¿æ¥ä¿¡æ¯è¯´æ˜ï¼š**
- `target_ip`ï¼šå®é™…è¿æ¥çš„ç›®æ ‡IPåœ°å€
- `socket_family`ï¼šè¿æ¥ç±»å‹ï¼ˆIPv4æˆ–IPv6ï¼‰
- `local_address`ï¼šæœ¬åœ°è¿æ¥åœ°å€
- `local_port`ï¼šæœ¬åœ°è¿æ¥ç«¯å£

#### 4. TLS/SSLä¿¡æ¯

```json
{
  "tls_info": {
    "protocol_version": "TLSv1.3",
    "cipher_suite": "TLS_AES_256_GCM_SHA384",
    "certificate": {
      "subject": {"CN": "example.com"},
      "issuer": {"CN": "DigiCert TLS RSA SHA256 2020 CA1"},
      "not_before": "2024-01-01T00:00:00",
      "not_after": "2025-01-01T00:00:00",
      "is_expired": false,
      "days_until_expiry": 120,
      "fingerprint_sha256": "abc123..."
    },
    "is_secure": true,
    "handshake_time_ms": 156.78
  }
}
```

**å®‰å…¨è¯„ä¼°ï¼š**
- `TLSv1.3`ï¼šæœ€æ–°æœ€å®‰å…¨çš„åè®®ç‰ˆæœ¬
- `TLSv1.2`ï¼šå®‰å…¨çš„åè®®ç‰ˆæœ¬
- `TLSv1.1åŠä»¥ä¸‹`ï¼šä¸æ¨èä½¿ç”¨
- `days_until_expiry < 30`ï¼šè¯ä¹¦å³å°†è¿‡æœŸï¼Œéœ€è¦æ›´æ–°

#### 5. HTTPå“åº”ä¿¡æ¯

```json
{
  "http_info": {
    "status_code": 200,
    "reason_phrase": "OK",
    "response_time_ms": 234.56,
    "headers": {
      "content-type": "text/html; charset=UTF-8",
      "server": "nginx/1.18.0"
    },
    "content_length": 1024,
    "redirects": []
  }
}
```

**çŠ¶æ€ç è§£è¯»ï¼š**
- `2xx`ï¼šæˆåŠŸå“åº”
- `3xx`ï¼šé‡å®šå‘å“åº”
- `4xx`ï¼šå®¢æˆ·ç«¯é”™è¯¯
- `5xx`ï¼šæœåŠ¡å™¨é”™è¯¯

**æ€§èƒ½æŒ‡æ ‡ï¼š**
- `< 200ms`ï¼šä¼˜ç§€çš„å“åº”æ€§èƒ½
- `200-500ms`ï¼šè‰¯å¥½çš„å“åº”æ€§èƒ½
- `500-1000ms`ï¼šä¸€èˆ¬çš„å“åº”æ€§èƒ½
- `> 1000ms`ï¼šè¾ƒæ…¢çš„å“åº”æ€§èƒ½

#### 6. ç½‘ç»œè·¯å¾„ä¿¡æ¯

```json
{
  "network_path": {
    "destination": "example.com",
    "hop_count": 8,
    "total_time_ms": 45.67,
    "trace_method": "mtr",
    "hops": [
      {
        "hop_number": 1,
        "ip_address": "192.168.1.1",
        "hostname": "gateway.local",
        "avg_time_ms": 1.23,
        "packet_loss_percent": 0.0
      },
      {
        "hop_number": 2,
        "ip_address": "10.0.0.1",
        "hostname": "isp.gateway",
        "avg_time_ms": 15.45,
        "packet_loss_percent": 0.0
      }
    ]
  }
}
```

**è·¯å¾„åˆ†æï¼š**
- `hop_count`ï¼šç½‘ç»œè·³æ•°ï¼Œé€šå¸¸8-15è·³ä¸ºæ­£å¸¸
- `packet_loss_percent`ï¼šä¸¢åŒ…ç‡ï¼Œåº”è¯¥ä¸º0%
- `avg_time_ms`ï¼šå¹³å‡å»¶è¿Ÿï¼Œæ¯è·³å¢åŠ 5-20msä¸ºæ­£å¸¸

### æ‰¹é‡è¯Šæ–­æŠ¥å‘Šè§£è¯»

#### 1. æ‰§è¡Œæ‘˜è¦

```json
{
  "execution_summary": {
    "total_targets": 5,
    "successful": 4,
    "failed": 1,
    "success_rate": 80.0,
    "total_execution_time_ms": 2345.67
  }
}
```

**å…³é”®æŒ‡æ ‡ï¼š**
- `success_rate > 95%`ï¼šç½‘ç»œçŠ¶å†µä¼˜ç§€
- `success_rate 80-95%`ï¼šç½‘ç»œçŠ¶å†µè‰¯å¥½
- `success_rate < 80%`ï¼šå¯èƒ½å­˜åœ¨ç½‘ç»œé—®é¢˜

#### 2. æ€§èƒ½ç»Ÿè®¡

```json
{
  "performance_statistics": {
    "average_diagnosis_time_ms": 468.13,
    "average_tcp_connect_time_ms": 45.23,
    "fastest_diagnosis_ms": 234.56,
    "slowest_diagnosis_ms": 789.01
  }
}
```

#### 3. å®‰å…¨ç»Ÿè®¡

```json
{
  "security_statistics": {
    "tls_enabled_count": 3,
    "secure_connections_rate": 75.0,
    "tls_protocols": {
      "TLSv1.3": 2,
      "TLSv1.2": 1
    }
  }
}
```

## ğŸ”§ å¸¸è§é—®é¢˜æ’æŸ¥

### å®‰è£…å’Œé…ç½®é—®é¢˜

#### Q1: uvå‘½ä»¤æœªæ‰¾åˆ°

**é—®é¢˜ï¼š** `command not found: uv`

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# é‡æ–°å®‰è£…uv
curl -LsSf https://astral.sh/uv/install.sh | sh

# é‡æ–°åŠ è½½shellé…ç½®
source ~/.bashrc  # æˆ– ~/.zshrc

# éªŒè¯å®‰è£…
uv --version
```

#### Q2: Pythonç‰ˆæœ¬ä¸å…¼å®¹

**é—®é¢˜ï¼š** `Python 3.11+ required`

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ£€æŸ¥Pythonç‰ˆæœ¬
python --version

# ä½¿ç”¨uvå®‰è£…æŒ‡å®šPythonç‰ˆæœ¬
uv python install 3.11

# ä½¿ç”¨æŒ‡å®šPythonç‰ˆæœ¬
uv run --python 3.11 python main.py google.com
```

#### Q3: ä¾èµ–å®‰è£…å¤±è´¥

**é—®é¢˜ï¼š** ä¾èµ–åŒ…å®‰è£…å¤±è´¥

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ¸…ç†ç¼“å­˜
uv cache clean

# é‡æ–°å®‰è£…ä¾èµ–
uv sync --reinstall

# æ‰‹åŠ¨å®‰è£…ç‰¹å®šåŒ…
uv add pydantic-settings --force-reinstall
```

### ç½‘ç»œè¯Šæ–­é—®é¢˜

#### Q4: è¿æ¥è¶…æ—¶

**é—®é¢˜ï¼š** `Connection timeout`

**å¯èƒ½åŸå› å’Œè§£å†³æ–¹æ¡ˆï¼š**

1. **ç½‘ç»œè¿æ¥é—®é¢˜**
   ```bash
   # æ£€æŸ¥ç½‘ç»œè¿æ¥
   ping google.com

   # å¢åŠ è¶…æ—¶æ—¶é—´
   echo "CONNECT_TIMEOUT=30" >> .env
   ```

2. **é˜²ç«å¢™é˜»æ­¢**
   ```bash
   # æ£€æŸ¥é˜²ç«å¢™çŠ¶æ€
   sudo ufw status  # Ubuntu

   # ä¸´æ—¶ç¦ç”¨é˜²ç«å¢™æµ‹è¯•
   sudo ufw disable
   ```

3. **ç›®æ ‡æœåŠ¡å™¨ä¸å¯è¾¾**
   ```bash
   # ä½¿ç”¨å…¶ä»–å·¥å…·éªŒè¯
   telnet example.com 443
   nc -zv example.com 443
   ```

#### Q5: TLSæ¡æ‰‹å¤±è´¥

**é—®é¢˜ï¼š** `TLS handshake failed`

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ£€æŸ¥TLSé…ç½®
openssl s_client -connect example.com:443

# è·³è¿‡TLSéªŒè¯ï¼ˆä»…ç”¨äºæµ‹è¯•ï¼‰
echo "VERIFY_SSL=false" >> .env
```

#### Q6: HTTPè¯·æ±‚å¤±è´¥

**é—®é¢˜ï¼š** `HTTP request failed`

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ£€æŸ¥HTTPå“åº”
curl -I https://example.com

# å¢åŠ é‡å®šå‘æ¬¡æ•°
echo "MAX_REDIRECTS=10" >> .env

# è·³è¿‡HTTPæ£€æŸ¥
uv run python main.py example.com --no-http
```

### æƒé™é—®é¢˜

#### Q7: mtrå‘½ä»¤éœ€è¦sudoæƒé™

**é—®é¢˜ï¼š** `mtr requires sudo privileges`

**è§£å†³æ–¹æ¡ˆï¼š**

1. **è®¾ç½®sudoå¯†ç **
   ```bash
   echo "SUDO_PASSWORD=your_password" >> .env
   ```

2. **é…ç½®sudoå…å¯†ç **
   ```bash
   # ç¼–è¾‘sudoersæ–‡ä»¶
   sudo visudo

   # æ·»åŠ ä»¥ä¸‹è¡Œï¼ˆæ›¿æ¢usernameä¸ºä½ çš„ç”¨æˆ·åï¼‰
   username ALL=(ALL) NOPASSWD: /usr/bin/mtr
   ```

3. **è·³è¿‡è·¯å¾„è¿½è¸ª**
   ```bash
   uv run python main.py example.com --no-trace
   ```

#### Q8: è¾“å‡ºç›®å½•æƒé™ä¸è¶³

**é—®é¢˜ï¼š** `Permission denied: output directory`

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# åˆ›å»ºè¾“å‡ºç›®å½•
mkdir -p output

# è®¾ç½®æƒé™
chmod 755 output

# æˆ–æ›´æ”¹è¾“å‡ºç›®å½•
echo "OUTPUT_DIR=/tmp/network_diagnosis" >> .env
```

### é…ç½®æ–‡ä»¶é—®é¢˜

#### Q9: YAMLæ ¼å¼é”™è¯¯

**é—®é¢˜ï¼š** `YAML parsing error`

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# éªŒè¯YAMLæ ¼å¼
uv run python batch_main.py --validate -c targets.yaml

# ä½¿ç”¨åœ¨çº¿YAMLéªŒè¯å™¨
# https://yamlchecker.com/

# é‡æ–°åˆ›å»ºç¤ºä¾‹é…ç½®
uv run python batch_main.py --create-sample
```

#### Q10: é…ç½®å‚æ•°æ— æ•ˆ

**é—®é¢˜ï¼š** `Invalid configuration parameter`

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ£€æŸ¥å‚æ•°èŒƒå›´
# max_concurrent: 1-10
# timeout_seconds: 10-300
# port: 1-65535

# æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯
uv run python batch_main.py -c targets.yaml --debug
```

### æ€§èƒ½é—®é¢˜

#### Q11: è¯Šæ–­é€Ÿåº¦æ…¢

**é—®é¢˜ï¼š** æ‰¹é‡è¯Šæ–­æ‰§è¡Œæ—¶é—´è¿‡é•¿

**è§£å†³æ–¹æ¡ˆï¼š**
```yaml
# ä¼˜åŒ–é…ç½®æ–‡ä»¶
global_settings:
  max_concurrent: 5  # å¢åŠ å¹¶å‘æ•°
  timeout_seconds: 30  # å‡å°‘è¶…æ—¶æ—¶é—´

targets:
  - domain: "example.com"
    include_trace: false  # è·³è¿‡è€—æ—¶çš„è·¯å¾„è¿½è¸ª
```

#### Q12: å†…å­˜ä½¿ç”¨è¿‡é«˜

**é—®é¢˜ï¼š** å†…å­˜ä½¿ç”¨è¿‡é«˜

**è§£å†³æ–¹æ¡ˆï¼š**
```yaml
# å‡å°‘å¹¶å‘æ•°
global_settings:
  max_concurrent: 2

# åˆ†æ‰¹å¤„ç†å¤§é‡ç›®æ ‡
# å°†å¤§é…ç½®æ–‡ä»¶æ‹†åˆ†ä¸ºå¤šä¸ªå°æ–‡ä»¶
```

## ğŸ­ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

### éƒ¨ç½²æ–¹å¼é€‰æ‹©

#### 1. ç›´æ¥éƒ¨ç½²ï¼ˆæ¨èç”¨äºå°è§„æ¨¡ï¼‰

**é€‚ç”¨åœºæ™¯ï¼š** å•æœºéƒ¨ç½²ï¼Œç›‘æ§ç›®æ ‡æ•°é‡ < 100

```bash
# 1. åˆ›å»ºä¸“ç”¨ç”¨æˆ·
sudo useradd -m -s /bin/bash netdiag
sudo usermod -aG sudo netdiag

# 2. é…ç½®sudoersï¼ˆæ— å¯†ç æ‰§è¡Œmtrï¼‰
sudo visudo
# æ·»åŠ ï¼šnetdiag ALL=(ALL) NOPASSWD: /usr/bin/mtr

# 3. å®‰è£…ä¾èµ–
sudo apt install -y mtr-tiny python3.11 python3.11-venv
curl -LsSf https://astral.sh/uv/install.sh | sh

# 4. éƒ¨ç½²åº”ç”¨
git clone https://github.com/Matthewyin/probing.git
cd probing
uv sync

# 5. é…ç½®systemdæœåŠ¡
sudo tee /etc/systemd/system/network-diagnosis.service << EOF
[Unit]
Description=Network Diagnosis Service
After=network.target

[Service]
Type=simple
User=netdiag
WorkingDirectory=/home/netdiag/probing
ExecStart=/home/netdiag/.local/bin/uv run python batch_main.py -c network-diagnosis/input/production.yaml
Restart=always
RestartSec=30

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl enable network-diagnosis
sudo systemctl start network-diagnosis
```

#### 2. å®¹å™¨åŒ–éƒ¨ç½²ï¼ˆæ¨èç”¨äºä¸­å¤§è§„æ¨¡ï¼‰

**é€‚ç”¨åœºæ™¯ï¼š** å¤šèŠ‚ç‚¹éƒ¨ç½²ï¼Œéœ€è¦æ‰©å±•æ€§å’Œéš”ç¦»æ€§

```dockerfile
# Dockerfile
FROM python:3.11-slim

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    mtr-tiny \
    traceroute \
    dnsutils \
    curl \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£…uv
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.local/bin:$PATH"

# åˆ›å»ºåº”ç”¨ç›®å½•
WORKDIR /app
COPY . .

# å®‰è£…Pythonä¾èµ–
RUN uv sync

# é…ç½®sudoersï¼ˆå®¹å™¨å†…å®‰å…¨ï¼‰
RUN echo "root ALL=(ALL) NOPASSWD: /usr/bin/mtr" >> /etc/sudoers

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:8080/health || exit 1

# è¿è¡Œåº”ç”¨
CMD ["uv", "run", "python", "batch_main.py", "-c", "network-diagnosis/input/production.yaml"]
```

```yaml
# docker-compose.yml
version: '3.8'
services:
  network-diagnosis:
    build: .
    volumes:
      - ./network-diagnosis/input:/app/network-diagnosis/input:ro
      - ./network-diagnosis/output:/app/network-diagnosis/output
      - ./network-diagnosis/log:/app/network-diagnosis/log
    environment:
      - LOG_LEVEL=INFO
      - MAX_CONCURRENT=5
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
```

### ç›‘æ§å’Œè¿ç»´

#### 1. æ—¥å¿—ç®¡ç†

```bash
# é…ç½®æ—¥å¿—è½®è½¬
sudo tee /etc/logrotate.d/network-diagnosis << EOF
/home/netdiag/probing/network-diagnosis/log/*/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 netdiag netdiag
}
EOF
```

#### 2. æ€§èƒ½ç›‘æ§

```bash
# ç›‘æ§è„šæœ¬ç¤ºä¾‹
#!/bin/bash
# monitor.sh

LOG_DIR="/home/netdiag/probing/network-diagnosis/log"
OUTPUT_DIR="/home/netdiag/probing/network-diagnosis/output"

# æ£€æŸ¥æœ€è¿‘çš„æ‰§è¡ŒçŠ¶æ€
LATEST_LOG=$(find $LOG_DIR -name "*.log" -type f -printf '%T@ %p\n' | sort -n | tail -1 | cut -d' ' -f2-)

if [ -n "$LATEST_LOG" ]; then
    # æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
    ERROR_COUNT=$(grep -c "ERROR" "$LATEST_LOG")
    SUCCESS_COUNT=$(grep -c "SUCCESS" "$LATEST_LOG")

    echo "æœ€è¿‘æ‰§è¡ŒçŠ¶æ€: æˆåŠŸ $SUCCESS_COUNT, é”™è¯¯ $ERROR_COUNT"

    # æ£€æŸ¥ç£ç›˜ä½¿ç”¨
    DISK_USAGE=$(df -h $OUTPUT_DIR | tail -1 | awk '{print $5}' | sed 's/%//')
    if [ $DISK_USAGE -gt 80 ]; then
        echo "è­¦å‘Š: ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜ ($DISK_USAGE%)"
    fi
fi
```

#### 3. å‘Šè­¦é…ç½®

```bash
# é›†æˆåˆ°ç›‘æ§ç³»ç»Ÿ
# Prometheus + Grafana ç¤ºä¾‹é…ç½®

# prometheus.yml
scrape_configs:
  - job_name: 'network-diagnosis'
    static_configs:
      - targets: ['localhost:8080']
    metrics_path: '/metrics'
    scrape_interval: 30s
```

### æ‰©å±•æ€§è€ƒè™‘

#### 1. æ°´å¹³æ‰©å±•

```yaml
# kuberneteséƒ¨ç½²ç¤ºä¾‹
apiVersion: apps/v1
kind: Deployment
metadata:
  name: network-diagnosis
spec:
  replicas: 3
  selector:
    matchLabels:
      app: network-diagnosis
  template:
    metadata:
      labels:
        app: network-diagnosis
    spec:
      containers:
      - name: network-diagnosis
        image: network-diagnosis:latest
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        volumeMounts:
        - name: config-volume
          mountPath: /app/network-diagnosis/input
        - name: output-volume
          mountPath: /app/network-diagnosis/output
      volumes:
      - name: config-volume
        configMap:
          name: diagnosis-config
      - name: output-volume
        persistentVolumeClaim:
          claimName: diagnosis-output-pvc
```

#### 2. è´Ÿè½½å‡è¡¡

```bash
# nginxé…ç½®ç¤ºä¾‹
upstream network_diagnosis {
    server diagnosis-1:8080;
    server diagnosis-2:8080;
    server diagnosis-3:8080;
}

server {
    listen 80;
    location / {
        proxy_pass http://network_diagnosis;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

## ğŸš€ é«˜çº§ç”¨æ³•

### ç¼–ç¨‹æ¥å£ä½¿ç”¨

#### 1. åŸºæœ¬ç¼–ç¨‹æ¥å£

```python
import asyncio
from src.network_diagnosis.diagnosis import DiagnosisCoordinator
from src.network_diagnosis.models import DiagnosisRequest

async def main():
    # åˆ›å»ºè¯Šæ–­è¯·æ±‚
    request = DiagnosisRequest(
        domain="google.com",
        port=443,
        include_trace=False,
        include_http=True
    )

    # æ‰§è¡Œè¯Šæ–­
    coordinator = DiagnosisCoordinator()
    result = await coordinator.diagnose(request)

    # å¤„ç†ç»“æœ
    print(f"è¯Šæ–­ç»“æœ: {result.success}")
    print(f"æ€»æ—¶é—´: {result.total_time_ms}ms")
    print(f"TCPè¿æ¥æ—¶é—´: {result.tcp_connection.connect_time_ms}ms")

if __name__ == "__main__":
    asyncio.run(main())
```

#### 2. æ‰¹é‡è¯Šæ–­ç¼–ç¨‹æ¥å£

```python
import asyncio
from src.network_diagnosis.batch_runner import BatchDiagnosisRunner

async def batch_diagnosis():
    # åˆ›å»ºæ‰¹é‡è¯Šæ–­è¿è¡Œå™¨
    runner = BatchDiagnosisRunner("targets.yaml")

    # æ‰§è¡Œæ‰¹é‡è¯Šæ–­
    result = await runner.run_batch_diagnosis()

    # å¤„ç†ç»“æœ
    print(f"æˆåŠŸç‡: {result.summary.execution_summary.success_rate}%")
    print(f"å¹³å‡è¯Šæ–­æ—¶é—´: {result.summary.performance_statistics.average_diagnosis_time_ms}ms")

    return result

if __name__ == "__main__":
    result = asyncio.run(batch_diagnosis())
```

### è‡ªå®šä¹‰é…ç½®

#### 1. ç¯å¢ƒç‰¹å®šé…ç½®

```bash
# å¼€å‘ç¯å¢ƒé…ç½®
cp .env .env.development
echo "DEBUG=true" >> .env.development
echo "LOG_LEVEL=DEBUG" >> .env.development

# ç”Ÿäº§ç¯å¢ƒé…ç½®
cp .env .env.production
echo "DEBUG=false" >> .env.production
echo "LOG_LEVEL=INFO" >> .env.production

# ä½¿ç”¨ç‰¹å®šç¯å¢ƒé…ç½®
ENV_FILE=.env.development uv run python main.py google.com
```

#### 2. è‡ªå®šä¹‰è¾“å‡ºæ ¼å¼

```python
# è‡ªå®šä¹‰ç»“æœå¤„ç†å™¨
from src.network_diagnosis.models import NetworkDiagnosisResult
import csv

def export_to_csv(results: list[NetworkDiagnosisResult], filename: str):
    """å°†è¯Šæ–­ç»“æœå¯¼å‡ºä¸ºCSVæ ¼å¼"""
    with open(filename, 'w', newline='') as csvfile:
        writer = csv.writer(csvfile)
        writer.writerow(['Domain', 'IP', 'Success', 'TCP Time', 'Total Time'])

        for result in results:
            writer.writerow([
                result.domain,
                result.target_ip,
                result.success,
                result.tcp_connection.connect_time_ms,
                result.total_time_ms
            ])
```

### ç›‘æ§å’Œå‘Šè­¦

#### 1. å®šæ—¶ç›‘æ§è„šæœ¬

```bash
#!/bin/bash
# monitor.sh - å®šæ—¶ç›‘æ§è„šæœ¬

cd /path/to/network-diagnosis

# æ‰§è¡Œè¯Šæ–­
uv run python batch_main.py -c production_targets.yaml --quiet

# æ£€æŸ¥ç»“æœ
if [ $? -eq 0 ]; then
    echo "$(date): ç›‘æ§æ­£å¸¸" >> monitor.log
else
    echo "$(date): ç›‘æ§å¼‚å¸¸" >> monitor.log
    # å‘é€å‘Šè­¦é‚®ä»¶
    echo "ç½‘ç»œè¯Šæ–­ç›‘æ§å¼‚å¸¸" | mail -s "ç›‘æ§å‘Šè­¦" admin@example.com
fi
```

#### 2. ç»“æœåˆ†æè„šæœ¬

```python
#!/usr/bin/env python3
# analyze_results.py - ç»“æœåˆ†æè„šæœ¬

import json
import glob
from datetime import datetime, timedelta

def analyze_recent_results(hours=24):
    """åˆ†ææœ€è¿‘Nå°æ—¶çš„è¯Šæ–­ç»“æœ"""
    cutoff_time = datetime.now() - timedelta(hours=hours)

    # æŸ¥æ‰¾æœ€è¿‘çš„ç»“æœæ–‡ä»¶
    pattern = "output/batch_diagnosis_report_*.json"
    files = glob.glob(pattern)

    recent_files = []
    for file in files:
        # ä»æ–‡ä»¶åæå–æ—¶é—´æˆ³
        timestamp_str = file.split('_')[-1].replace('.json', '')
        file_time = datetime.strptime(timestamp_str, '%Y%m%d_%H%M%S')

        if file_time > cutoff_time:
            recent_files.append(file)

    # åˆ†æç»“æœ
    total_targets = 0
    total_successful = 0

    for file in recent_files:
        with open(file, 'r') as f:
            data = json.load(f)
            summary = data['summary']['execution_summary']
            total_targets += summary['total_targets']
            total_successful += summary['successful']

    if total_targets > 0:
        success_rate = (total_successful / total_targets) * 100
        print(f"æœ€è¿‘{hours}å°æ—¶æˆåŠŸç‡: {success_rate:.1f}%")

        if success_rate < 95:
            print("âš ï¸  æˆåŠŸç‡ä½äº95%ï¼Œéœ€è¦å…³æ³¨")
    else:
        print("æ²¡æœ‰æ‰¾åˆ°æœ€è¿‘çš„è¯Šæ–­ç»“æœ")

if __name__ == "__main__":
    analyze_recent_results(24)
```

### é›†æˆå…¶ä»–å·¥å…·

#### 1. ä¸Prometheusé›†æˆ

```python
# prometheus_exporter.py
from prometheus_client import start_http_server, Gauge, Counter
import json
import time

# å®šä¹‰æŒ‡æ ‡
diagnosis_success_rate = Gauge('network_diagnosis_success_rate', 'Network diagnosis success rate')
diagnosis_response_time = Gauge('network_diagnosis_response_time_ms', 'Average response time', ['target'])
diagnosis_total = Counter('network_diagnosis_total', 'Total diagnoses', ['target', 'status'])

def export_metrics():
    """å¯¼å‡ºæŒ‡æ ‡åˆ°Prometheus"""
    # è¯»å–æœ€æ–°çš„æ‰¹é‡è¯Šæ–­æŠ¥å‘Š
    with open('output/latest_batch_report.json', 'r') as f:
        data = json.load(f)

    # æ›´æ–°æŒ‡æ ‡
    summary = data['summary']
    diagnosis_success_rate.set(summary['execution_summary']['success_rate'])

    for result in data['individual_results']:
        target = result['domain']
        status = 'success' if result['success'] else 'failure'

        diagnosis_total.labels(target=target, status=status).inc()
        if result['success']:
            diagnosis_response_time.labels(target=target).set(result['total_time_ms'])

if __name__ == '__main__':
    start_http_server(8000)
    while True:
        export_metrics()
        time.sleep(60)
```

#### 2. ä¸Grafanaé›†æˆ

```json
{
  "dashboard": {
    "title": "ç½‘ç»œè¯Šæ–­ç›‘æ§",
    "panels": [
      {
        "title": "æˆåŠŸç‡",
        "type": "stat",
        "targets": [
          {
            "expr": "network_diagnosis_success_rate",
            "legendFormat": "æˆåŠŸç‡"
          }
        ]
      },
      {
        "title": "å“åº”æ—¶é—´",
        "type": "graph",
        "targets": [
          {
            "expr": "network_diagnosis_response_time_ms",
            "legendFormat": "{{target}}"
          }
        ]
      }
    ]
  }
}
```

## âš¡ æ€§èƒ½ä¼˜åŒ–

### å¹¶å‘é…ç½®æŒ‡å¯¼

#### 1. å¹¶å‘æ•°é€‰æ‹©

æ ¹æ®ä¸åŒåœºæ™¯é€‰æ‹©åˆé€‚çš„å¹¶å‘æ•°ï¼š

| åœºæ™¯ | æ¨èå¹¶å‘æ•° | åŸå›  |
|------|------------|------|
| æœ¬åœ°æµ‹è¯• | 1-2 | é¿å…å¯¹ç›®æ ‡æœåŠ¡å™¨é€ æˆå‹åŠ› |
| å†…ç½‘ç›‘æ§ | 3-5 | å¹³è¡¡æ€§èƒ½å’Œç¨³å®šæ€§ |
| äº’è”ç½‘ç›‘æ§ | 2-3 | é¿å…è¢«è¯¯è®¤ä¸ºæ”»å‡» |
| å¤§è§„æ¨¡ç›‘æ§ | 5-10 | æœ€å¤§åŒ–æ€§èƒ½ï¼Œéœ€è¦ä¼˜è´¨ç½‘ç»œ |

#### 2. è¶…æ—¶æ—¶é—´é…ç½®

```yaml
global_settings:
  timeout_seconds: 30   # å¿«é€Ÿç½‘ç»œ
  # timeout_seconds: 60   # ä¸€èˆ¬ç½‘ç»œ
  # timeout_seconds: 120  # æ…¢é€Ÿç½‘ç»œæˆ–åŒ…å«è·¯å¾„è¿½è¸ª
```

#### 3. æ€§èƒ½ä¼˜åŒ–å»ºè®®

**å‡å°‘è¯Šæ–­æ—¶é—´ï¼š**
```yaml
targets:
  - domain: "example.com"
    include_trace: false  # è·³è¿‡è€—æ—¶çš„è·¯å¾„è¿½è¸ª
    include_http: true    # ä¿ç•™HTTPæ£€æŸ¥
```

**æ‰¹é‡å¤„ç†ä¼˜åŒ–ï¼š**
```bash
# åˆ†æ‰¹å¤„ç†å¤§é‡ç›®æ ‡
# å°†100ä¸ªç›®æ ‡åˆ†æˆ5ä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ªæ–‡ä»¶20ä¸ªç›®æ ‡
# targets_batch1.yaml, targets_batch2.yaml, ...

for i in {1..5}; do
    uv run python batch_main.py -c targets_batch${i}.yaml &
done
wait
```

### èµ„æºä½¿ç”¨ä¼˜åŒ–

#### 1. å†…å­˜ä¼˜åŒ–

```python
# å¤§æ‰¹é‡è¯Šæ–­æ—¶çš„å†…å­˜ä¼˜åŒ–
import gc

async def memory_efficient_batch_diagnosis(targets, batch_size=50):
    """å†…å­˜é«˜æ•ˆçš„æ‰¹é‡è¯Šæ–­"""
    for i in range(0, len(targets), batch_size):
        batch = targets[i:i + batch_size]

        # å¤„ç†å½“å‰æ‰¹æ¬¡
        results = await process_batch(batch)

        # ä¿å­˜ç»“æœå¹¶æ¸…ç†å†…å­˜
        save_batch_results(results)
        del results
        gc.collect()

        # æ‰¹æ¬¡é—´ä¼‘æ¯
        await asyncio.sleep(1)
```

#### 2. ç½‘ç»œä¼˜åŒ–

```yaml
# ç½‘ç»œä¼˜åŒ–é…ç½®
global_settings:
  max_concurrent: 3
  timeout_seconds: 30

  # å‡å°‘HTTPé‡å®šå‘æ¬¡æ•°
  max_redirects: 3

  # ä¼˜åŒ–è¿æ¥è¶…æ—¶
  connect_timeout: 10
  read_timeout: 20
```

### ç›‘æ§å’Œè°ƒä¼˜

#### 1. æ€§èƒ½ç›‘æ§

```python
# performance_monitor.py
import time
import psutil
from src.network_diagnosis.batch_runner import BatchDiagnosisRunner

class PerformanceMonitor:
    def __init__(self):
        self.start_time = None
        self.start_memory = None

    def start_monitoring(self):
        self.start_time = time.time()
        self.start_memory = psutil.Process().memory_info().rss

    def stop_monitoring(self):
        end_time = time.time()
        end_memory = psutil.Process().memory_info().rss

        duration = end_time - self.start_time
        memory_used = (end_memory - self.start_memory) / 1024 / 1024  # MB

        print(f"æ‰§è¡Œæ—¶é—´: {duration:.2f}ç§’")
        print(f"å†…å­˜ä½¿ç”¨: {memory_used:.2f}MB")

        return {
            'duration': duration,
            'memory_used_mb': memory_used
        }

# ä½¿ç”¨ç¤ºä¾‹
async def monitored_diagnosis():
    monitor = PerformanceMonitor()
    monitor.start_monitoring()

    runner = BatchDiagnosisRunner("targets.yaml")
    result = await runner.run_batch_diagnosis()

    stats = monitor.stop_monitoring()
    print(f"è¯Šæ–­äº†{len(result.individual_results)}ä¸ªç›®æ ‡")
    print(f"å¹³å‡æ¯ä¸ªç›®æ ‡è€—æ—¶: {stats['duration']/len(result.individual_results):.2f}ç§’")
```

#### 2. è‡ªåŠ¨è°ƒä¼˜

```python
# auto_tuning.py
def calculate_optimal_settings(target_count, network_quality='good'):
    """æ ¹æ®ç›®æ ‡æ•°é‡å’Œç½‘ç»œè´¨é‡è‡ªåŠ¨è®¡ç®—æœ€ä¼˜è®¾ç½®"""

    # åŸºç¡€å¹¶å‘æ•°
    base_concurrent = {
        'poor': 1,
        'fair': 2,
        'good': 3,
        'excellent': 5
    }.get(network_quality, 3)

    # æ ¹æ®ç›®æ ‡æ•°é‡è°ƒæ•´
    if target_count <= 5:
        max_concurrent = min(base_concurrent, target_count)
    elif target_count <= 20:
        max_concurrent = min(base_concurrent + 1, 5)
    else:
        max_concurrent = min(base_concurrent + 2, 10)

    # æ ¹æ®å¹¶å‘æ•°è°ƒæ•´è¶…æ—¶æ—¶é—´
    timeout_seconds = max(30, 60 - (max_concurrent * 5))

    return {
        'max_concurrent': max_concurrent,
        'timeout_seconds': timeout_seconds
    }

# ä½¿ç”¨ç¤ºä¾‹
settings = calculate_optimal_settings(target_count=15, network_quality='good')
print(f"æ¨èè®¾ç½®: {settings}")
```

### æœ€ä½³å®è·µæ€»ç»“

#### 1. é…ç½®æœ€ä½³å®è·µ

```yaml
# æ¨èçš„ç”Ÿäº§ç¯å¢ƒé…ç½®
global_settings:
  # ä¿å®ˆçš„å¹¶å‘è®¾ç½®
  max_concurrent: 3
  timeout_seconds: 60

  # å®Œæ•´çš„è¾“å‡ºè®¾ç½®
  save_individual_files: true
  save_summary_report: true
  include_performance_analysis: true
  include_security_analysis: true

  # é»˜è®¤è®¾ç½®
  default_port: 443
  default_include_trace: false  # ç”Ÿäº§ç¯å¢ƒå»ºè®®å…³é—­
  default_include_http: true

targets:
  # ä¸ºæ¯ä¸ªç›®æ ‡æ·»åŠ æè¿°
  - domain: "api.example.com"
    description: "ç”Ÿäº§APIæœåŠ¡å™¨"
    port: 443
    include_http: true
    include_trace: false
```

#### 2. è¿ç»´æœ€ä½³å®è·µ

```bash
#!/bin/bash
# production_monitor.sh - ç”Ÿäº§ç¯å¢ƒç›‘æ§è„šæœ¬

# è®¾ç½®å·¥ä½œç›®å½•
cd /opt/network-diagnosis

# è®¾ç½®æ—¥å¿—
LOG_FILE="/var/log/network-diagnosis.log"
DATE=$(date '+%Y-%m-%d %H:%M:%S')

# æ‰§è¡Œè¯Šæ–­
echo "[$DATE] å¼€å§‹ç½‘ç»œè¯Šæ–­" >> $LOG_FILE

if uv run python batch_main.py -c production_targets.yaml --quiet; then
    echo "[$DATE] è¯Šæ–­æˆåŠŸå®Œæˆ" >> $LOG_FILE

    # æ£€æŸ¥æˆåŠŸç‡
    SUCCESS_RATE=$(python3 -c "
import json, glob
files = glob.glob('output/batch_diagnosis_report_*.json')
if files:
    with open(max(files), 'r') as f:
        data = json.load(f)
        print(data['summary']['execution_summary']['success_rate'])
else:
    print(0)
")

    if (( $(echo "$SUCCESS_RATE < 95" | bc -l) )); then
        echo "[$DATE] è­¦å‘Š: æˆåŠŸç‡ä½äº95% ($SUCCESS_RATE%)" >> $LOG_FILE
        # å‘é€å‘Šè­¦
        echo "ç½‘ç»œè¯Šæ–­æˆåŠŸç‡ä½äº95%: $SUCCESS_RATE%" | \
            mail -s "ç½‘ç»œç›‘æ§å‘Šè­¦" admin@example.com
    fi
else
    echo "[$DATE] è¯Šæ–­æ‰§è¡Œå¤±è´¥" >> $LOG_FILE
    # å‘é€é”™è¯¯å‘Šè­¦
    echo "ç½‘ç»œè¯Šæ–­æ‰§è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç³»ç»ŸçŠ¶æ€" | \
        mail -s "ç½‘ç»œç›‘æ§é”™è¯¯" admin@example.com
fi

# æ¸…ç†æ—§æ–‡ä»¶ï¼ˆä¿ç•™æœ€è¿‘7å¤©ï¼‰
find output/ -name "*.json" -mtime +7 -delete
find /var/log/ -name "network-diagnosis.log.*" -mtime +30 -delete

echo "[$DATE] ç›‘æ§ä»»åŠ¡å®Œæˆ" >> $LOG_FILE
```

#### 3. å®‰å…¨æœ€ä½³å®è·µ

```bash
# 1. è®¾ç½®é€‚å½“çš„æ–‡ä»¶æƒé™
chmod 600 .env                    # é…ç½®æ–‡ä»¶åªæœ‰æ‰€æœ‰è€…å¯è¯»å†™
chmod 755 output/                 # è¾“å‡ºç›®å½•å¯è¯»å¯æ‰§è¡Œ
chmod 644 output/*.json           # è¾“å‡ºæ–‡ä»¶å¯è¯»

# 2. å®šæœŸè½®æ¢æ—¥å¿—
logrotate -f /etc/logrotate.d/network-diagnosis

# 3. ç›‘æ§å¼‚å¸¸è®¿é—®
tail -f /var/log/network-diagnosis.log | grep -i "error\|fail\|timeout"
```

---

## ğŸ“š æ€»ç»“

æœ¬ç”¨æˆ·æ‰‹å†Œæ¶µç›–äº†ç½‘ç»œè¯Šæ–­å·¥å…·çš„å®Œæ•´ä½¿ç”¨æ–¹æ³•ï¼Œä»åŸºç¡€å®‰è£…åˆ°é«˜çº§ä¼˜åŒ–ã€‚ä¸»è¦å†…å®¹åŒ…æ‹¬ï¼š

- **åŸºç¡€ä½¿ç”¨**ï¼šå•ç›®æ ‡å’Œæ‰¹é‡è¯Šæ–­çš„åŸºæœ¬æ“ä½œ
- **é…ç½®ç®¡ç†**ï¼šç¯å¢ƒå˜é‡å’ŒYAMLé…ç½®æ–‡ä»¶çš„ä½¿ç”¨
- **ç»“æœè§£è¯»**ï¼šè¯¦ç»†çš„è¾“å‡ºæ ¼å¼è¯´æ˜å’Œæ€§èƒ½æŒ‡æ ‡è§£è¯»
- **é—®é¢˜æ’æŸ¥**ï¼šå¸¸è§é—®é¢˜çš„è¯Šæ–­å’Œè§£å†³æ–¹æ¡ˆ
- **é«˜çº§åŠŸèƒ½**ï¼šç¼–ç¨‹æ¥å£ã€ç›‘æ§é›†æˆå’Œæ€§èƒ½ä¼˜åŒ–

é€šè¿‡éµå¾ªæœ¬æ‰‹å†Œçš„æŒ‡å¯¼ï¼Œæ‚¨å¯ä»¥å……åˆ†åˆ©ç”¨ç½‘ç»œè¯Šæ–­å·¥å…·çš„æ‰€æœ‰åŠŸèƒ½ï¼Œå®ç°é«˜æ•ˆçš„ç½‘ç»œç›‘æ§å’Œæ•…éšœæ’æŸ¥ã€‚

å¦‚éœ€æ›´å¤šæŠ€æœ¯ç»†èŠ‚ï¼Œè¯·å‚è€ƒï¼š
- [æ¶æ„æ–‡æ¡£](ARCHITECTURE.md) - è¯¦ç»†çš„æŠ€æœ¯æ¶æ„è¯´æ˜
- [é…ç½®æŒ‡å—](CONFIG_USAGE.md) - é…ç½®æ–‡ä»¶è¯¦ç»†è¯´æ˜
- [é¡¹ç›®æ€»ç»“](PROJECT_SUMMARY.md) - é¡¹ç›®åŠŸèƒ½æ¦‚è¿°
